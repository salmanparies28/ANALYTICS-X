<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Bill</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
</head>
<body>
<div class="container">
    <h1>Create Bill</h1>

    <h2>Add Product</h2>
    <form id="product-form">
        <div class="form-group">
            <label for="SKU">Product SKU:</label>
            <input type="text" id="SKU" name="SKU" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="quantity">Quantity:</label>
            <input type="number" id="quantity" name="quantity" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Add Product</button>
    </form>

    <h2>Products in Bill</h2>
    <ul id="product-list" class="list-group">
    </ul>
    <h3>Total: <span id="total-price">0</span></h3>

    <h2>Customer Details (Optional)</h2>
    <form id="customer-form">
        <div class="form-group">
            <label for="customer_name">Customer Name:</label>
            <input type="text" id="customer_name" name="customer_name" class="form-control">
        </div>
        <div class="form-group">
            <label for="customer_phone">Customer Phone:</label>
            <input type="text" id="customer_phone" name="customer_phone" class="form-control">
        </div>
        <button type="submit" class="btn btn-success">Finalize Bill</button>
    </form>

    <h2>Invoice</h2>
    <div id="invoice" class="card">
        <div class="card-body">
            <h4>Bill No: <span id="invoice-bill-no"></span></h4>
            <p>Customer: <span id="invoice-customer-name"></span></p>
            <p>Phone: <span id="invoice-customer-phone"></span></p>
            <p>Date: <span id="invoice-date"></span></p>
            <h5>Items</h5>
            <ul id="invoice-items" class="list-group">
            </ul>
            <h4>Total Price: <span id="invoice-total-price"></span></h4>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $.ajax({
            url: '/billing/start_transaction',
            type: 'POST',
            success: function (response) {
                console.log('Transaction started');
            }
        });

        $('#product-form').submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/billing/add_product',
                type: 'POST',
                data: $(this).serialize(),
                success: function (response) {
                    if (response.status === 'success') {
                        $('#product-list').append('<li class="list-group-item">' + response.product_name + ' - ' + response.quantity + ' - ' + response.total_price + '</li>');
                        updateTotalPrice();
                    } else {
                        alert(response.message);
                    }
                }
            });
        });

        $('#customer-form').submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/billing/finalize_bill',
                type: 'POST',
                data: $(this).serialize(),
                success: function (response) {
                    if (response.status === 'success') {
                        $('#total-price').text(response.total_price);
                        loadInvoice();
                    }
                }
            });
        });

        function updateTotalPrice() {
            $.ajax({
                url: '/billing/view_bill',
                type: 'GET',
                success: function (response) {
                    $('#total-price').text(response.total_price);
                }
            });
        }

        function loadInvoice() {
            $.ajax({
                url: '/billing/view_bill',
                type: 'GET',
                success: function (response) {
                    $('#invoice-bill-no').text(response.bill_no);
                    $('#invoice-customer-name').text(response.customer_name);
                    $('#invoice-customer-phone').text(response.customer_phone);
                    $('#invoice-date').text(response.date);
                    $('#invoice-items').empty();
                    response.items.forEach(item => {
                        $('#invoice-items').append('<li class="list-group-item">' + item.product_name + ' - ' + item.quantity + ' - ' + item.total_price + '</li>');
                    });
                    $('#invoice-total-price').text(response.total_price);
                }
            });
        }
    });
</script>
</body>
</html>
